""" @app.route('/users/<int:user_id>', methods=['GET','PATCH','PUT','DELETE'])
def user(user_id):
    user = Users.query.get(user_id)
    if user is None:
        return jsonify({'Mensaje': 'Usuario no encontrado'}), 404
    elif request.method == 'PUT':
        try:
            user_data = UserSchema().load(request.json)
            user.username = user_data['username']
            user.email = user_data['email']
            if 'password' in user_data:
                user.set_password(user_data['password'])
            db.session.commit()
        except ValidationError as err:
            return jsonify({'Mensaje': f'Error en la validación: {err.messages}'}),400 """


elif request.method == 'PUT':
        try:
            user_data = UserSchema().load(request.json)
            print("Datos recibidos:", user_data)  # Depuración de los datos recibidos
            
            user.username = user_data['username']
            user.email = user_data['email']

            if 'role' in user_data and user_data['role']:
                user.role = user_data['role']

            if 'password' in user_data and user_data['password']:
                user.set_password(user_data['password'])

            db.session.commit()
            return jsonify({'Mensaje': 'Usuario actualizado correctamente'}), 200

        except ValidationError as err:
            return jsonify({'Mensaje': f'Error en la validación', 'Errores': err.messages}), 400

        except Exception as e:
            # Loguear el error para depurar
            print("Error interno en PUT /users:", e)
            return jsonify({'Mensaje': 'Error interno del servidor', 'Error': str(e)}), 500


    if request.method == 'POST':
        try:
            user_data = UserSchema().load(request.json)
            new_user = Users(
                username=user_data['username'],
                email=user_data['email'],
                role=user_data.get('role', 'user') 
            )
            new_user.set_password(user_data['password'])
            db.session.add(new_user)
            db.session.commit()
            return UserSchema().dump(new_user), 201
        except ValidationError as err:
            return {'Mensaje': f'Error en la validación: {err.messages}'}, 400
    
    # Manejo para el método GET
    elif request.method == 'GET':
        all_users = Users.query.all()
        return {'users': UserSchema(many=True).dump(all_users)}, 200